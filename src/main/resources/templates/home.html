<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>首页</title>

    <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.js"></script>

    <style >
        html body {
            height: 100%;
            width: 100%;
        }

        #captchaContainer{
            position: absolute;
            top: 50px;
            left: 20%;
            /*background-color: #f57a7a;*/
            height: 340px;
            width: 600px;
        }
        .header{

            position: absolute;
            top: 0px;
            left: 300px;
            background-color: rgb(245, 236, 236);
            height: 40px;
            width: 300px;
        }
        .headerText{
            position: absolute;
            top: 13px;
            left: 90px;
            height: 40px;

            color:#66c523;
            font:18px/14px Georgia, "Times New Roman", Times, serif;


        }
        #reInit{
            position: absolute;
            top: 0px;
            right: 0px;
            background-color: #827af5;
            height: 40px;
            width: 40px;
        }

        #captchaImg{
            position: absolute;
            left: 0;
            top: 0;

            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            border: none


        }
        #oriImg{
            position: absolute;
            left: 300px;
            top: 40px;
            width: 300px;
            height: 260px;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            border: none

        }
        #cutImg{
            position: absolute;
            left: 100px;
            top: 40px;
            width: 300px;
            height: 260px;
            border: none
        }
        #message{

            position: relative;
            left: 370px;
            top: 160px;
            font-size:25px;
            color: hsl(241, 86%, 23%);
        }

        #message_success{

            position: relative;
            left: 370px;
            top: 160px;
            font-size:25px;
            font-weight: 900;
            color: #ec3655;
        }

        #message_fail{

            position: relative;
            left: 370px;
            top: 160px;
            font-size:25px;
            color: #ec3655;
        }



        .sliderContainer {
            position: absolute;
            bottom: 0;
            left: 300px;
            text-align: center;
            width: 300px;
            height: 40px;
            line-height: 40px;
            background: #f7f9fa;
            color: #45494c;
            border: 1px solid #e4e7eb;

        }

        .sliderContainer_success{
            border: 1px solid hsl(125, 93%, 44%);
        }
        .sliderContainer_fail{
            border: 1px solid #ec3655;
        }

        .slider {
            position: absolute;
            top: 0;
            left: 0px;
            width: 40px;
            height: 40px;
            background: #fff;
            box-shadow: 0 0 3px rgba(0, 0, 0, 0.3);
            transition: background .2s linear;
            cursor: pointer;
            cursor: grab;
        }
        .slider_success{
            border: 1px solid hsl(125, 93%, 44%);
        }
        .slider_fail{
            border: 1px solid #ec3655;
        }






        .block {
            position: absolute;
            left: 0;
            top: 0;
            cursor: pointer;
            cursor: grab;
        }

        .block:active {
            cursor: pointer;
            cursor: grabbing;
        }



        .sliderContainer_active .slider {
            height: 38px;
            top: -1px;
            border: 1px solid #1991FA;
        }

        .sliderContainer_active .sliderMask {
            height: 38px;
            border-width: 1px;
        }

        .sliderContainer_success .slider {
            height: 38px;
            top: -1px;
            margin-left: -1px;
            border: 1px solid #52CCBA;
            background-color: #52CCBA !important;
        }

        .sliderContainer_success .sliderMask {
            height: 38px;
            border: 1px solid #52CCBA;
            background-color: #D2F4EF;
        }

        .sliderContainer_success .sliderIcon {
            background-position: 0 0 !important;
        }

        .sliderContainer_fail .slider {
            height: 38px;
            top: -1px;
            border: 1px solid #f57a7a;
            background-color: #f57a7a !important;
        }

        .sliderContainer_fail .sliderMask {
            height: 38px;
            border: 1px solid #f57a7a;
            background-color: #fce1e1;
        }

        .sliderContainer_fail .sliderIcon {
            top: 14px;
            background-position: 0 -82px !important;
        }
        .sliderContainer_active .sliderText, .sliderContainer_success .sliderText, .sliderContainer_fail .sliderText {
            display: none;
        }

        .sliderMask {
            position: absolute;
            left: 0;
            top: 0;
            height: 40px;
            border: 0 solid #1991FA;
            background: #D1E9FE;
        }



        .slider:active {
            cursor: grabbing;
        }

        .slider:hover {
            background: #1991FA;
        }

        .slider:hover .sliderIcon {
            background-position: 0 -13px;
        }

        .sliderIcon {
            position: absolute;
            top: 15px;
            left: 13px;
            width: 14px;
            height: 12px;
            background: url(http://cstaticdun.126.net//2.6.3/images/icon_light.f13cff3.png) 0 -26px;
            background-size: 34px 471px;
        }

        .refreshIcon {
            position: absolute;
            right: 0;
            top: 0;
            width: 34px;
            height: 34px;
            cursor: pointer;
            background: url(http://cstaticdun.126.net//2.6.3/images/icon_light.f13cff3.png) 0 -437px;
            background-size: 34px 471px;
        }



    </style>

</head>
<body>
    
    <div id="captchaContainer">
        <!-- 标题栏　-->
        <div class="header">
            <span class="headerText">图片滑动验证</span>
            <img id="reInit" src="/static/reInitIcon.png"/>
        </div> 

        <!-- 图片显示区域　-->
        <div id="captchaImg">
              
            <img id="oriImg" />
            <img id="cutImg" />
<!--            <span id="message">图片验证成功</span>-->
                        
        </div>
        <!--滑块显示区域-->
         <div class="sliderContainer">
            <div class="sliderMask">
                <div class="slider">
                    <span class="sliderIcon"></span>
                </div>
            </div>
            <span class="sliderText">向右滑动填充拼图</span>
            
        </div> 

        
    </div>

    <img src="reInitIcon.png"/>

    <img src="static/reInitIcon.png"/>

    <img src="/static/reInitIcon.png"/>
    
</body>

<script>
    var base64PrefixPath="data:image/png;base64,";

    //客户端返回的抠图原点X位置
    var XPOS;

    var IMAGE_WIDTH = 300;
    var RADIUS = 15;
    //初始化
    var InitCutImageOffset =0;
    //滑块初始偏移量
    var sliderInitOffset = 0;
    //滑块移动的最值
    var MIN_MOVE = 0;
    var MAX_MOVE = 260;
    //鼠标按下标志
    var mousedownFlag=false;
    //滑块移动的距离
    var moveX;
    //滑块位置检测允许的误差，正负２
    var MOVE_CHECK_ERROR = 2;
    //滑块滑动使能
    var moveEnable = true;

  　//加载页面时进行初始化
    function init(){
        console.log("init")



        moveEnable = true;
        mousedownFlag=false;
        console.log("InitCutImageOffset = " + InitCutImageOffset);
        InitCutImageOffset = IMAGE_WIDTH - XPOS + RADIUS;
        console.log("InitCutImageOffset = " + InitCutImageOffset);
        $("#cutImg").css("left",InitCutImageOffset+"px");
        $(".slider").css("left",0+"px");

        initClass();



    }
    //加载页面时
    $(function(){

        httpRequest.requestImage.request();
    })

    var httpRequest={
      //请求获取图片
      requestImage:{
        path: "slider/image",
        request:function(){
            $.get(httpRequest.requestImage.path,function(data,status){

                console.log(data)
                console.log(data.message);

                if(data.data != null){
                    XPOS= data.data.xpos;
                    var oriImageSrc = base64PrefixPath + data.data.oriImage;
                    var cutImageSrc = base64PrefixPath + data.data.cutImage;

                    $("#oriImg").attr("src",oriImageSrc)
                    $("#cutImg").attr("src",cutImageSrc)

                    init();
                }

          });
        },
      },
      //请求验证
      requestVerification:{
        path: "slider/verification",
        request:function(){
            $.get(httpRequest.requestVerification.path,{moveX:(moveX+RADIUS)},function(data,status){
                console.log(data)
                console.log(data.code);
                console.log(data.message);

                if(data.data == true){
                    checkSuccessHandle();
                }
                else{
                    checkFailHandle();
                }
          });
        },
      },
    }

    //刷新图片操作
    $("#reInit").on("click",function(){
        httpRequest.requestImage.request();
    })

    //滑块鼠标按下
    $(".slider").mousedown(function(event){
        console.log("鼠标按下mousedown:"+event.clientX + " " + event.clientY);
        sliderInitOffset = event.clientX;  
        mousedownFlag = true;

        

        //滑块绑定鼠标滑动事件
        $(".slider").on("mousemove",function(event){
            if(mousedownFlag  == false){
              return;
            }
            if(moveEnable == false){
              return
            }

            moveX = event.clientX - sliderInitOffset;
            moveX<MIN_MOVE?moveX=MIN_MOVE:moveX=moveX;
            moveX>MAX_MOVE?moveX=MAX_MOVE:moveX=moveX;


            $(this).css("left",moveX+"px");
            $("#cutImg").css("left",InitCutImageOffset+moveX+"px");
        })

    })
    //滑块鼠标弹起操作
    $(".slider").mouseup(function(event){
        console.log("mouseup:"+event.clientX + " " + event.clientY);
        sliderInitOffset = 0;
        $(this).off("mousemove");
        mousedownFlag=false;
        console.log("moveX　＝　" + moveX)
        checkLocation();
        
    })
    //检测滑块　位置是否正确
    function checkLocation(){

        moveEnable = false;
        httpRequest.requestVerification.request();
        /*
        if(( XPOS > ( moveX - MOVE_CHECK_ERROR)) 
        && (XPOS < ( moveX + MOVE_CHECK_ERROR))){
          console.log("验证成功");
            checkSuccessHandle();
        }
        else{
          console.log("验证失败");
          checkFailHandle();
        }*/
    }

    function checkSuccessHandle(){
      $(".sliderContainer").addClass("sliderContainer_success");
      $(".slider").addClass("slider_success");
    }
    function checkFailHandle(){
      $(".sliderContainer").addClass("sliderContainer_fail");
      $(".slider").addClass("slider_success");
    }

    function initClass(){
      $(".sliderContainer").removeClass("sliderContainer_success");
      $(".slider").removeClass("slider_success");
  
      $(".sliderContainer").removeClass("sliderContainer_fail");
      $(".slider").removeClass("slider_fail");
    }
    


</script>


</html>